{% load static %}
<!DOCTYPE html>
<html lang="cs" class="h-full" data-theme>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}FAX Portal{% endblock %}</title>
  <link rel="manifest" href="/manifest.json" />

  <!-- Preload dark-mode to avoid FOUC -->
  <script>
    (() => {
      try {
        const ls = localStorage.getItem("theme");
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = ls ? ls === 'dark' : prefersDark;
        if (useDark) document.documentElement.classList.add('dark');
      } catch (_) {}
    })();
  </script>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: '#4f46e5', 50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca' }
          },
          boxShadow: { soft: '0 8px 30px rgba(0,0,0,.06)' }
        }
      }
    }
  </script>

  <!-- Project CSS -->
  <link rel="stylesheet" href="{% static 'fax_calendar/datepicker.css' %}" />
  <link rel="stylesheet" href="{% static 'wiki/css/infobox.css' %}" />
  <link rel="stylesheet" href="{% static 'wiki/css/infobox.country.css' %}" />
  <link rel="stylesheet" href="{% static 'wiki/css/infobox.city.css' %}" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{% static 'shell/home.css' %}" />

  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { scrollbar-width: none; }
  </style>
  {% block extra_head %}{% endblock %} {# MSA-REDESIGN: allow per-app head #}
</head>
<body class="flex min-h-dvh flex-col bg-gradient-to-b from-white to-slate-50 text-slate-900 dark:from-slate-950 dark:to-slate-900 dark:text-slate-100">

  <!-- ===== Topbar ===== -->
  <header class="sticky top-0 z-[1000] border-b border-slate-200/70 bg-white/70 backdrop-blur supports-[backdrop-filter]:bg-white/50 dark:border-slate-800/70 dark:bg-slate-900/70">
    <div class="flex h-14 w-full items-center gap-2 px-3 sm:h-16 sm:px-6">

      <!-- Left: nav controls + home -->
      <div class="flex items-center gap-1">
        <button id="back-btn" class="inline-flex h-9 w-9 items-center justify-center rounded-lg hover:bg-slate-100 active:scale-95 dark:hover:bg-slate-800" aria-label="Zpƒõt">
          <i data-lucide="chevron-left" class="h-4 w-4"></i>
        </button>
        <button id="fwd-btn" class="inline-flex h-9 w-9 items-center justify-center rounded-lg hover:bg-slate-100 active:scale-95 dark:hover:bg-slate-800" aria-label="Vp≈ôed">
          <i data-lucide="chevron-right" class="h-4 w-4"></i>
        </button>
        <button id="reload-btn" class="inline-flex h-9 w-9 items-center justify-center rounded-lg hover:bg-slate-100 active:scale-95 dark:hover:bg-slate-800" aria-label="Obnovit">
          <i data-lucide="rotate-cw" class="h-4 w-4"></i>
        </button>

        <a href="/" aria-label="Dom≈Ø" class="ml-1 inline-flex h-9 w-9 items-center justify-center rounded-lg hover:bg-slate-100 active:scale-95 dark:hover:bg-slate-800">
          <i data-lucide="home" class="h-4 w-4"></i>
        </a>
      </div>

      <!-- Center: search (desktop) ‚Äì rozt√°hnout mezi lev√Ω a prav√Ω blok -->
      <form id="global-search" action="/search" method="get" class="hidden sm:flex flex-1 min-w-0 items-center" role="search">
        <div class="relative w-full">
          <input id="search-input" name="q" type="search" placeholder="Hledat Woorld‚Ä¶ (/, Ctrl/‚åòK)" aria-label="Hledat" autocomplete="off"
                 aria-haspopup="listbox" aria-expanded="false" aria-controls="search-sugg-desktop"
                 class="w-full rounded-xl border border-slate-300 bg-white/90 pl-9 pr-3 py-2 text-sm text-slate-900 shadow-soft placeholder:text-slate-400 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-100 dark:border-slate-700 dark:bg-slate-900/80 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-slate-700" />
          <svg class="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <!-- panel s n√°vrhy p≈ôid√°me v JS -->
        </div>
      </form>

      <!-- Right: Woorld date, admin, theme toggle, menu -->
      <div class="ml-auto flex items-center gap-1">

        <!-- Woorld date button + panel -->
        <div id="woorld-date" class="relative">
          <button id="woorld-date-btn"
                  class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white/80 px-3 py-1.5 text-sm hover:bg-slate-100 active:scale-[.99] dark:border-slate-700 dark:bg-slate-900/70 dark:hover:bg-slate-800"
                  aria-haspopup="dialog" aria-expanded="false">
            <span class="text-slate-500">üìÖ</span>
            <span id="woorld-date-text">01.01.2020</span>
          </button>
          <div id="woorld-date-panel"
               class="hidden absolute right-0 mt-2 w-[min(92vw,420px)] rounded-2xl border border-slate-200 bg-white p-2 shadow-xl dark:border-slate-800 dark:bg-slate-900">
            <div id="woorld-widget" class="rounded-xl border border-slate-200 bg-white p-2 dark:border-slate-800 dark:bg-slate-900">
              {% include "fax_calendar/_woorld_date_control.html" %}
            </div>
          </div>
        </div>

        <!-- Spr√°vcovsk√Ω re≈æim ON/OFF -->
        {% if request.user.is_staff %}
        <form method="post" action="{% url 'admin-toggle' %}" class="mx-1">{% csrf_token %}
          <button
            class="inline-flex items-center gap-2 rounded-lg border px-2.5 py-1.5 text-xs font-medium transition
            {% if request.session.admin_mode %}
              border-emerald-300 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 dark:border-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300
            {% else %}
              border-slate-300 bg-white text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-300 dark:hover:bg-slate-800
            {% endif %}">
            <span class="text-[12px]">‚öôÔ∏è</span>
            {% if request.session.admin_mode %}Spr√°vce ON{% else %}Spr√°vce OFF{% endif %}
          </button>
        </form>
        {% endif %}

        <!-- Theme toggle -->
        <button id="theme-toggle" class="inline-flex h-9 w-9 items-center justify-center rounded-lg hover:bg-slate-100 active:scale-95 dark:hover:bg-slate-800" aria-label="P≈ôepnout t√©ma">
          <span class="dark:hidden">‚òÄÔ∏è</span>
          <span class="hidden dark:inline">üåô</span>
        </button>

        <!-- User (placeholder) -->
        <a href="#" class="rounded-lg px-2 py-1.5 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">üë§</a>

        <!-- Kebab menu -->
        <div class="relative">
          <button id="menu-btn" class="inline-flex h-9 w-9 items-center justify-center rounded-lg hover:bg-slate-100 active:scale-95 dark:hover:bg-slate-800" aria-haspopup="menu" aria-expanded="false">‚ãØ</button>
          <div id="menu-dropdown" class="invisible absolute right-0 mt-2 w-48 translate-y-2 rounded-xl border border-slate-200 bg-white p-1 opacity-0 shadow-xl transition-all dark:border-slate-800 dark:bg-slate-900" role="menu">
            <a href="#" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800" role="menuitem">Nov√° karta</a>
            <a href="#" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800" role="menuitem">Nov√© okno</a>
            <a href="#" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800" role="menuitem">Nastaven√≠</a>
            {% if request.user.is_staff %}
            <a href="/admin/" class="block rounded-lg px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800" role="menuitem">‚öôÔ∏è Admin</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile search -->
    <form id="global-search-mobile" action="/search" method="get" class="sm:hidden border-t border-slate-200/70 px-3 py-2 dark:border-slate-800/70" role="search">
      <div class="relative">
        <input name="q" type="search" placeholder="Hledat‚Ä¶ (/, Ctrl/‚åòK)" class="w-full rounded-lg border border-slate-300 bg-white/90 pl-9 pr-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900/80" autocomplete="off"
               aria-haspopup="listbox" aria-expanded="false" aria-controls="search-sugg-mobile" />
        <svg class="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <!-- panel s n√°vrhy p≈ôid√°me v JS -->
      </div>
    </form>
  </header>

  <!-- ===== Tab strip (pod topbarem) ===== -->
  <div id="tab-strip"
       class="sticky top-14 sm:top-16 z-[900] border-b border-slate-200 bg-white/70 px-2 py-1 text-sm backdrop-blur supports-[backdrop-filter]:bg-white/50 dark:border-slate-800 dark:bg-slate-900/70">
    <div class="flex w-full items-center gap-2">
      <div class="relative">
        <button id="tab-dropdown" class="inline-flex h-8 items-center rounded-lg px-2 hover:bg-slate-100 active:scale-[.98] dark:hover:bg-slate-800" aria-label="Seznam oken">‚ñæ</button>
        <div id="tab-dropdown-panel" class="hidden absolute left-2 top-full mt-2 w-[min(92vw,360px)] rounded-2xl border border-slate-200 bg-white p-1 shadow-xl dark:border-slate-800 dark:bg-slate-900"></div>
      </div>
      <ul id="tab-list" role="tablist" class="no-scrollbar flex flex-1 items-center gap-2 overflow-x-auto px-1"></ul>
      <div class="relative">
        <button id="tab-new" class="inline-flex h-8 items-center rounded-lg px-2 hover:bg-slate-100 active:scale-[.98] dark:hover:bg-slate-800" aria-label="Nov√° z√°lo≈æka">Ôºã</button>
        <div id="tab-new-panel" class="hidden absolute right-0 top-full mt-2 w-[min(92vw,380px)] rounded-2xl border border-slate-200 bg-white p-3 shadow-xl dark:border-slate-800 dark:bg-slate-900">
          <div class="text-sm font-medium mb-2">Otev≈ô√≠t novou z√°lo≈æku</div>
          <div class="grid grid-cols-2 gap-2 mb-2">
            <button data-href="/" class="rounded-lg border px-3 py-2 text-left hover:bg-slate-50 dark:hover:bg-slate-800">/ (Dom≈Ø)</button>
            <button data-href="/wiki/" class="rounded-lg border px-3 py-2 text-left hover:bg-slate-50 dark:hover:bg-slate-800">/wiki/</button>
            <button data-href="/maps/" class="rounded-lg border px-3 py-2 text-left hover:bg-slate-50 dark:hover:bg-slate-800">/maps/</button>
            <button data-href="/livesport/" class="rounded-lg border px-3 py-2 text-left hover:bg-slate-50 dark:hover:bg-slate-800">/livesport/</button>
          </div>
          <div class="flex items-center gap-2">
            <input id="tab-new-input" type="text" placeholder="/cesta" class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
            <button id="tab-new-confirm" class="rounded-lg bg-brand px-3 py-2 text-sm font-medium text-white hover:bg-brand/90">Otev≈ô√≠t</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page content -->
  <main id="page" class="flex-1 overflow-y-auto px-3 py-4 sm:px-6">
    {% block content %}{% endblock %}
  </main>

  <!-- ===== Scripts ===== -->
  <script src="{% static 'admin/js/core.js' %}"></script>
  <script type="module" src="{% static 'fax_calendar/core.js' %}"></script>
  <script type="module" src="{% static 'fax_calendar/astro.js' %}"></script>
  <script type="module" src="{% static 'fax_calendar/datepicker.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{% static 'wiki/dataseries.js' %}"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="{% static 'wiki/dataseries-ui.js' %}"></script>
  <script src="{% static 'shell/home-widgets.js' %}"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Lucide -> inline SVG
    try { window.lucide?.createIcons(); } catch(_) {}

    // ---------- Topbar controls ----------
    const backBtn = document.getElementById('back-btn');
    const fwdBtn = document.getElementById('fwd-btn');
    const reloadBtn = document.getElementById('reload-btn');
    backBtn?.addEventListener('click', () => history.back());
    fwdBtn?.addEventListener('click', () => history.forward());
    reloadBtn?.addEventListener('click', () => location.reload());

    // Kebab dropdown
    const kebabBtn = document.getElementById('menu-btn');
    const kebabDrop = document.getElementById('menu-dropdown');
    const toggleMenu = (open) => {
      kebabDrop.style.opacity = open ? '1' : '0';
      kebabDrop.style.transform = open ? 'translateY(0)' : 'translateY(8px)';
      kebabDrop.style.visibility = open ? 'visible' : 'hidden';
      kebabBtn.setAttribute('aria-expanded', String(!!open));
    };
    kebabBtn?.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(kebabDrop.style.opacity !== '1'); });

    // Theme toggle
    const themeBtn = document.getElementById('theme-toggle');
    themeBtn?.addEventListener('click', () => {
      const html = document.documentElement;
      const isDark = html.classList.toggle('dark');
      try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(_) {}
    });

    // Helper: preferuj viditeln√© desktopov√© pole
    function findSearchInput() {
      const desktop = document.querySelector('#global-search input[name="q"]');
      if (desktop && desktop.offsetParent !== null) return desktop;
      return document.querySelector('#global-search-mobile input[name="q"]') || desktop;
    }

    // Zkratky fokus: Ctrl/Cmd+K a "/"
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        const input = findSearchInput();
        if (input) { e.preventDefault(); input.focus(); input.select?.(); }
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
        const a = document.activeElement;
        const isField =
          a &&
          (a.tagName === 'INPUT' ||
            a.tagName === 'TEXTAREA' ||
            a.getAttribute('contenteditable') === 'true');
        if (!isField) {
          const input = findSearchInput();
          if (input) { e.preventDefault(); input.focus(); input.select?.(); }
        }
      }
    });

    // ---------- Woorld Date ----------
    const WD_KEY = 'woorld.date';
    const wdBtn = document.getElementById('woorld-date-btn');
    const wdText = document.getElementById('woorld-date-text');
    const wdPanel = document.getElementById('woorld-date-panel');
    function formatDDMMYYYY(iso) {
      try { const [y,m,d] = iso.split('-'); return `${d}.${m}.${y}`; } catch { return iso; }
    }
    function getStoredDate() { return localStorage.getItem(WD_KEY) || '2020-01-01'; }
    function setStoredDate(iso) { localStorage.setItem(WD_KEY, iso); wdText.textContent = formatDDMMYYYY(iso); }
    setStoredDate(getStoredDate());
    function toggleWoorld(open) {
      wdPanel.classList.toggle('hidden', !open);
      wdBtn.setAttribute('aria-expanded', String(!!open));
      if (open) {
        try {
          const widget = document.getElementById('woorld-widget');
          widget?.querySelectorAll('label, p, span, div').forEach(el => {
            if (/aktu√°ln√≠.*datum.*woorldu/i.test(el.textContent || '')) el.classList.add('hidden');
          });
          const iso = getStoredDate();
          const dateInput =
            widget.querySelector('input[type="date"]') ||
            widget.querySelector('input[id*="date" i], input[name*="date" i]');
          if (dateInput) {
            dateInput.value = iso;
            dateInput.dispatchEvent(new Event('change', { bubbles: true }));
            dateInput.addEventListener('change', () => setStoredDate(dateInput.value));
          }
          widget.querySelectorAll('input.woorld-date-input,[data-fax-date]').forEach(el => {
            el.value = iso;
            el.addEventListener('change', () => setStoredDate(el.value));
          });
        } catch (_) {}
      }
    }
    wdBtn?.addEventListener('click', (e) => { e.stopPropagation(); toggleWoorld(wdPanel.classList.contains('hidden')); });

    // ---------- Tab Strip ----------
    const TABS_KEY = 'fax.tabs.v1';
    const ACTIVE_KEY = 'fax.tabs.activeId';
    const tabList = document.getElementById('tab-list');
    const tabDropBtn = document.getElementById('tab-dropdown');
    const tabDropPanel = document.getElementById('tab-dropdown-panel');
    const tabNewBtn = document.getElementById('tab-new');
    const tabNewPanel = document.getElementById('tab-new-panel');
    const tabNewInput = document.getElementById('tab-new-input');
    const tabNewConfirm = document.getElementById('tab-new-confirm');

    function loadTabs() {
      let tabs = [];
      let activeId = null;
      try {
        tabs = JSON.parse(localStorage.getItem(TABS_KEY) || '[]');
        activeId = localStorage.getItem(ACTIVE_KEY) || null;
      } catch(_) {}
      if (!Array.isArray(tabs) || tabs.length === 0) {
        const t = { id: 't-' + Date.now(), title: document.title || 'Okno', href: location.pathname + location.search + location.hash, icon: 'üóÇÔ∏è', pinned: false };
        tabs = [t]; activeId = t.id;
        saveTabs(tabs, activeId);
      }
      return { tabs, activeId };
    }
    function saveTabs(tabs, activeId) {
      try {
        localStorage.setItem(TABS_KEY, JSON.stringify(tabs));
        if (activeId) localStorage.setItem(ACTIVE_KEY, activeId);
      } catch(_) {}
    }
    function humanize(url) {
      try {
        const u = new URL(url, location.origin);
        if (u.pathname === '/' || u.pathname === '') return 'Dom≈Ø';
        const seg = u.pathname.replace(/^\//,'').split('/')[0] || 'Str√°nka';
        return decodeURIComponent(seg);
      } catch { return url.length > 24 ? url.slice(0,24) + '‚Ä¶' : url; }
    }
    function renderTabs() {
      const { tabs, activeId } = loadTabs();
      tabList.innerHTML = '';
      tabs.forEach((t) => {
        const li = document.createElement('li');
        li.setAttribute('role', 'tab');
        li.setAttribute('aria-selected', String(t.id === activeId));
        li.tabIndex = 0;
        li.className = [
          'group inline-flex items-center gap-2 rounded-lg px-3 py-1.5 cursor-pointer select-none',
          t.id === activeId ? 'bg-white dark:bg-slate-800 shadow' : 'hover:bg-slate-100 dark:hover:bg-slate-800'
        ].join(' ');
        li.innerHTML = `<span class="text-base">${t.icon || 'üåê'}</span>
                        <span class="text-sm max-w-[18ch] truncate">${t.title || humanize(t.href)}</span>
                        ${t.pinned ? '' : '<button class="tab-close opacity-0 group-hover:opacity-100 transition h-5 w-5 rounded hover:bg-slate-200 dark:hover:bg-slate-700" aria-label="Zav≈ô√≠t">√ó</button>'}`;
        li.addEventListener('click', (e) => {
          if (e.target.closest('.tab-close')) return;
          saveTabs(tabs, t.id);
          if (location.pathname + location.search + location.hash !== t.href) location.href = t.href;
        });
        li.querySelector('.tab-close')?.addEventListener('click', (e) => {
          e.stopPropagation();
          closeTab(t.id);
        });
        li.addEventListener('keydown', (e) => { if (e.key === 'Enter') li.click(); });
        tabList.appendChild(li);
      });
      tabDropPanel.innerHTML = '';
      tabs.forEach((t) => {
        const a = document.createElement('a');
        a.className = 'flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800';
        a.href = t.href;
        a.innerHTML = `<span class="text-base">${t.icon || 'üåê'}</span>
                       <span class="text-sm">${t.title || humanize(t.href)}</span>`;
        tabDropPanel.appendChild(a);
      });
    }
    function closeTab(id) {
      const state = loadTabs();
      if (state.tabs.length <= 1) return;
      const idx = state.tabs.findIndex(t => t.id === id);
      const wasActive = state.activeId === id;
      const next = state.tabs.filter(t => t.id !== id);
      let nextActive = state.activeId;
      if (wasActive) {
        const neighbor = next[Math.min(idx, next.length - 1)];
        nextActive = neighbor?.id || next[0]?.id || null;
      }
      saveTabs(next, nextActive);
      renderTabs();
      if (wasActive) {
        const activeTab = next.find(t => t.id === nextActive);
        if (activeTab && (location.pathname + location.search + location.hash) !== activeTab.href) {
          location.href = activeTab.href;
        }
      }
    }
    function newTab(href) {
      const state = loadTabs();
      const t = { id: 't-' + Date.now(), title: humanize(href), href, icon: 'üåê', pinned: false };
      state.tabs.push(t);
      saveTabs(state.tabs, t.id);
      renderTabs();
      if ((location.pathname + location.search + location.hash) !== href) location.href = href;
    }
    renderTabs();

    // Dropdowns + New-tab panel
    const toggle = (el, show) => el.classList.toggle('hidden', !show);
    document.getElementById('tab-dropdown')?.addEventListener('click', (e) => { e.stopPropagation(); toggle(document.getElementById('tab-dropdown-panel'), document.getElementById('tab-dropdown-panel').classList.contains('hidden')); });
    document.getElementById('tab-new')?.addEventListener('click', (e) => { e.stopPropagation(); toggle(document.getElementById('tab-new-panel'), document.getElementById('tab-new-panel').classList.contains('hidden')); document.getElementById('tab-new-input')?.focus(); });
    document.querySelectorAll('#tab-new-panel button[data-href]')?.forEach(btn => btn.addEventListener('click', () => newTab(btn.getAttribute('data-href'))));
    document.getElementById('tab-new-confirm')?.addEventListener('click', () => {
      const v = (document.getElementById('tab-new-input')?.value || '/').trim() || '/';
      newTab(v);
    });

    // Kl√°vesov√© zkratky pro list tab≈Ø
    document.addEventListener('keydown', (e) => {
      const isCmd = e.metaKey || e.ctrlKey;
      if (isCmd && e.key.toLowerCase() === 't') { e.preventDefault(); document.getElementById('tab-new')?.click(); }
      if (isCmd && e.key.toLowerCase() === 'w') { e.preventDefault();
        const { tabs, activeId } = loadTabs();
        const active = tabs.find(t => t.id === activeId);
        if (active && !active.pinned && tabs.length > 1) closeTab(active.id);
      }
      if (isCmd && !e.shiftKey && e.key === 'Tab') { e.preventDefault();
        const { tabs, activeId } = loadTabs();
        const i = tabs.findIndex(t => t.id === activeId);
        const next = tabs[(i + 1) % tabs.length]; saveTabs(tabs, next.id); renderTabs(); location.href = next.href;
      }
      if (isCmd && e.shiftKey && e.key === 'Tab') { e.preventDefault();
        const { tabs, activeId } = loadTabs();
        const i = tabs.findIndex(t => t.id === activeId);
        const next = tabs[(i - 1 + tabs.length) % tabs.length]; saveTabs(tabs, next.id); renderTabs(); location.href = next.href;
      }
    });

    // Outside-click to close panels
    document.addEventListener('click', (e) => {
      if (!kebabDrop.contains(e.target) && !kebabBtn.contains(e.target)) toggleMenu(false);
      if (!document.getElementById('tab-dropdown-panel').contains(e.target) && !document.getElementById('tab-dropdown').contains(e.target)) document.getElementById('tab-dropdown-panel').classList.add('hidden');
      if (!document.getElementById('tab-new-panel').contains(e.target) && !document.getElementById('tab-new').contains(e.target)) document.getElementById('tab-new-panel').classList.add('hidden');
      if (!wdPanel.contains(e.target) && !wdBtn.contains(e.target)) wdPanel.classList.add('hidden');
    });

    if (document.getElementById('widgets')) {
      initHomeWidgets();
    }

    // ---------- Search: p≈ô√≠m√© zkratky ----------
    function normalize(str) {
      try { return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim(); }
      catch { return (str || '').toLowerCase().trim(); }
    }
    function appShortcutPath(q) {
      const v = normalize(q);
      if (!v) return null;
      if (v === '/' || v === 'domu' || v === 'dom≈Ø' || v === 'home') return '/';
      if (v === 'wiki') return '/wiki/';
      if (v === 'mapy' || v === 'maps') return '/maps/';
      if (v === 'sport' || v === 'livesport') return '/livesport/';
      if (v === 'msa' || v === 'squash') return '/msasquashtour/';
      if (v === 'mma') return '/mma/';
      if (v === 'openfaxmap' || v === 'ofm') return '/openfaxmap/';
      return null;
    }
    function bindSearchShortcuts(formSelector) {
      const form = document.querySelector(formSelector);
      if (!form) return;
      form.addEventListener('submit', (e) => {
        const input = form.querySelector('input[name="q"]');
        const q = (input?.value || '').trim();
        const path = appShortcutPath(q);
        if (path) {
          e.preventDefault();
          location.href = path;
        }
      });
    }
    bindSearchShortcuts('#global-search');
    bindSearchShortcuts('#global-search-mobile');

    // ---------- Search suggestions: stabiln√≠ na≈°ept√°vaƒç ----------
    const SUGGEST_URL = '/search/suggest';
    const STATIC_PAGES = [
      { title: 'Wiki', url: '/wiki/', keys: ['wiki'] },
      { title: 'Mapy', url: '/maps/', keys: ['mapy','maps'] },
      { title: 'LiveSport', url: '/livesport/', keys: ['sport','livesport'] },
      { title: 'MSA Squash Tour', url: '/msasquashtour/', keys: ['msa','squash'] },
      { title: 'MMA port√°l', url: '/mma/', keys: ['mma'] },
      { title: 'OpenFaxMap', url: '/openfaxmap/', keys: ['openfaxmap','ofm'] },
      { title: 'Dom≈Ø', url: '/', keys: ['domu','dom≈Ø','home','/'] },
    ];

    function createPanel(id) {
      const panel = document.createElement('div');
      panel.id = id;
      panel.setAttribute('role', 'listbox');
      panel.className =
        'hidden absolute left-0 right-0 mt-1 max-h-80 overflow-auto rounded-xl border border-slate-200 bg-white p-1 text-sm shadow-xl dark:border-slate-800 dark:bg-slate-900 z-[1100]';
      return panel;
    }

    function attachSuggest(formSelector, panelId) {
      const form = document.querySelector(formSelector);
      if (!form) return;
      const input = form.querySelector('input[name="q"]');
      if (!input) return;

      const wrapper = input.closest('.relative') || form;
      let panel = document.getElementById(panelId);
      if (!panel) {
        panel = createPanel(panelId);
        wrapper.appendChild(panel);
      }
      input.setAttribute('aria-controls', panelId);

      let active = -1;
      let lastQuery = '';
      let reqId = 0;
      let ignoreBlur = false;
      let remoteDownUntil = 0;

      const now = () => Date.now();
      const remoteEnabled = () => now() > remoteDownUntil;

      const closePanel = () => {
        panel.classList.add('hidden');
        input.setAttribute('aria-expanded', 'false');
        input.removeAttribute('aria-activedescendant');
        active = -1;
      };

      const setActive = (i) => {
        const items = Array.from(panel.querySelectorAll('[role="option"]'));
        items.forEach((el, idx) => {
          el.classList.toggle('bg-slate-100', idx === i);
          el.setAttribute('aria-selected', String(idx === i));
        });
        active = i;
        if (i >= 0 && items[i]) input.setAttribute('aria-activedescendant', items[i].id);
        else input.removeAttribute('aria-activedescendant');
      };

      const norm = (s) => normalize(String(s||''));
      const uniqByUrl = (arr) => {
        const out = [];
        const seen = new Set();
        for (const x of arr) {
          if (!x || !x.url) continue;
          if (!/^\/|^https?:\/\//i.test(x.url)) continue;
          if (seen.has(x.url)) continue;
          seen.add(x.url); out.push(x);
        }
        return out;
      };

      const staticMatches = (q) => {
        const v = norm(q);
        if (!v) return STATIC_PAGES.slice(0, 5);
        const res = [];
        for (const p of STATIC_PAGES) {
          const hit = p.keys.some(k => norm(k).startsWith(v) || v.startsWith(norm(k)));
          if (hit) res.push({ title: p.title, url: p.url });
        }
        return res;
      };

      const render = (items) => {
        if (!items || items.length === 0) { closePanel(); return; }
        panel.innerHTML = '';
        items.slice(0, 8).forEach((it, i) => {
          const id = `${panelId}-opt-${i}`;
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.id = id;
          btn.setAttribute('role', 'option');
          btn.setAttribute('aria-selected', 'false');
          btn.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800';
          btn.innerHTML = `<span class="block font-medium truncate">${it.title || it.url}</span>
                           <span class="block text-[11px] opacity-60 truncate">${it.url}</span>`;
          // pointerdown = jistota p≈ôed blur (funguje i na dotyk)
          btn.addEventListener('pointerdown', (ev) => {
            ev.preventDefault();
            ignoreBlur = true;
            location.href = it.url;
          });
          panel.appendChild(btn);
        });
        panel.classList.remove('hidden');
        input.setAttribute('aria-expanded', 'true');
        setActive(-1);
      };

      const fetchSuggest = async (q, myId) => {
        try {
          const res = await fetch(`${SUGGEST_URL}?q=${encodeURIComponent(q)}`, {
            headers: { 'Accept': 'application/json' },
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          if (myId !== reqId) return; // star√° odpovƒõƒè ‚Äì ignoruj
          let arr = [];
          if (Array.isArray(data)) {
            arr = data.map(x => typeof x === 'string' ? { title: x, url: x } : x);
          } else if (Array.isArray(data?.results)) {
            arr = data.results;
          }
          const merged = uniqByUrl(arr.length ? arr : staticMatches(q));
          render(merged);
        } catch (err) {
          // Backend je doƒçasnƒõ dole ‚Äì na 60s p≈ôejdeme na ƒçistƒõ statick√© n√°vrhy
          remoteDownUntil = now() + 60000;
          if (myId !== reqId) return;
          render(staticMatches(q));
        }
      };

      // Debounce
      let t = null;
      const onInput = () => {
        const q = input.value.trim();
        if (q === lastQuery) return;
        lastQuery = q;
        clearTimeout(t);
        t = setTimeout(() => {
          if (!q) { render(staticMatches('')); return; }
          if (!remoteEnabled() || q.length < 2) {
            render(uniqByUrl(staticMatches(q)));
          } else {
            const myId = ++reqId;
            fetchSuggest(q, myId);
          }
        }, 150);
      };

      input.addEventListener('input', onInput);
      input.addEventListener('focus', () => {
        const q = input.value.trim();
        if (!q || q.length < 2 || !remoteEnabled()) render(staticMatches(q));
        else { const myId = ++reqId; fetchSuggest(q, myId); }
      });
      input.addEventListener('blur', () => {
        // pokud klik√°me do panelu, nechej otev≈ôen√© ‚Äì zav≈ôe se po navigaci
        setTimeout(() => { if (!ignoreBlur) closePanel(); ignoreBlur = false; }, 0);
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !panel.classList.contains('hidden')) {
          e.preventDefault();
          closePanel();
          return;
        }
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          const items = Array.from(panel.querySelectorAll('[role="option"]'));
          if (!items.length) return;
          e.preventDefault();
          let next = active + (e.key === 'ArrowDown' ? 1 : -1);
          if (next < 0) next = items.length - 1;
          if (next >= items.length) next = 0;
          setActive(next);
        }
      });

      // Submit: zkratky na hlavn√≠ str√°nky; jinak defaultn√≠ /search
      form.addEventListener('submit', (e) => {
        const q = input.value.trim();
        const path = appShortcutPath(q);
        if (path) { e.preventDefault(); location.href = path; }
      });

      // Klik mimo ‚Äì zav≈ôi panel
      document.addEventListener('click', (ev) => {
        if (!panel.contains(ev.target) && ev.target !== input) closePanel();
      });
    }

    attachSuggest('#global-search', 'search-sugg-desktop');
    attachSuggest('#global-search-mobile', 'search-sugg-mobile');

    // Service worker
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('/service-worker.js');
  });
  </script>
</body>
</html>
