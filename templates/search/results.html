{% extends "base.html" %}
{% block content %}
<section class="max-w-6xl mx-auto px-4 py-6">
  <form action="/search" method="get" role="search" class="sticky top-14 sm:top-16 z-10 mb-4 bg-white/70 dark:bg-slate-950/70 backdrop-blur supports-[backdrop-filter]:bg-white/50">
    <input name="q" value="{{ q|default:'' }}" type="search" placeholder="Hledat Woorld…"
      class="w-full rounded-xl border border-slate-300 bg-white/70 dark:bg-slate-900/60 px-4 py-3 shadow-soft focus:ring-2 focus:ring-brand-100 dark:focus:ring-slate-700" />
  </form>

  {% if q %}
    {% if results %}
    <div id="toolbar" class="mb-4 flex flex-wrap items-center gap-2 text-sm">
      <div aria-live="polite">Výsledky pro „{{ q }}“ (<span id="shown-count">{{ results|length }}</span>)</div>
      <div id="filter-chips" class="flex flex-wrap gap-2 ml-auto">
        {% for t in types %}
        <button type="button" class="filter-chip rounded-full px-2.5 py-1.5 text-xs border hover:bg-slate-100 dark:hover:bg-slate-800" data-type="{{ t }}">{{ t }}</button>
        {% endfor %}
      </div>
      <select id="sort-select" class="rounded-lg border px-2 py-1 text-xs">
        <option value="relevance">Relevance</option>
        <option value="newest">Nejnovější</option>
        <option value="oldest">Nejstarší</option>
      </select>
    </div>

    <div id="result-list" class="grid gap-4 md:grid-cols-2">
      {% for r in results %}
      <article class="result-card rounded-2xl border border-slate-200 bg-white p-4 shadow-soft hover:shadow-md transition dark:border-slate-800 dark:bg-slate-900" data-type="{{ r.type }}" {% if r.date %}data-date="{{ r.date|date:'c' }}"{% endif %}>
        <div class="mb-1">
          <span class="text-[11px] uppercase tracking-wide px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700">{{ r.type }}</span>
        </div>
        <h3 class="text-lg font-semibold"><a href="{{ r.url }}" class="r-title text-brand-600 dark:text-brand-400 hover:underline">{{ r.title }}</a></h3>
        {% if r.snippet %}
        <p class="r-snippet mt-1 text-sm text-slate-700 dark:text-slate-300 line-clamp-3">{{ r.snippet }}</p>
        {% endif %}
        {% if r.date %}
        <div class="mt-2 text-xs text-slate-500">{{ r.date|date:"Y-m-d" }}</div>
        {% endif %}
      </article>
      {% endfor %}
    </div>

    <div class="text-center mt-6">
      <button id="load-more" type="button" class="rounded-lg border px-4 py-2">Zobrazit další</button>
    </div>
    {% else %}
    <div class="rounded-2xl border border-slate-200 bg-white p-6 text-sm text-slate-500 shadow-soft dark:border-slate-800 dark:bg-slate-900">
      Nic jsme nenašli. Zkuste kratší dotaz nebo jiný tvar bez diakritiky.
    </div>
    {% endif %}
  {% else %}
    <div class="text-sm text-slate-500">Zadejte dotaz a stiskněte Enter.</div>
  {% endif %}
</section>

{% if q %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const norm = (s) => (s || '').normalize('NFKD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
  const input = document.querySelector('form[role="search"] input[name="q"]');
  input.focus();
  document.addEventListener('keydown', e => {
    if (e.key === '/' && document.activeElement !== input) {
      e.preventDefault();
      input.focus();
    }
  });
  input.addEventListener('keydown', e => { if (e.key === 'Escape') { input.value = ''; } });

  const q = norm('{{ q|escapejs }}');
  const cards = Array.from(document.querySelectorAll('.result-card'));
  const countEl = document.getElementById('shown-count');
  const btnMore = document.getElementById('load-more');
  const pageSize = 12;
  let shown = pageSize;
  const activeTypes = new Set();
  let sortMode = 'relevance';

  const highlight = (el) => {
    const text = el.textContent;
    const map = [];
    let normText = '';
    for (let i = 0; i < text.length; i++) {
      const n = norm(text[i]);
      for (const c of n) { map.push(i); normText += c; }
    }
    const idx = normText.indexOf(q);
    if (idx === -1) return;
    const start = map[idx];
    const end = map[idx + q.length - 1] + 1;
    el.innerHTML =
      text.slice(0, start) +
      '<mark class="rounded px-1 py-0.5 bg-yellow-200/50 dark:bg-yellow-300/20">' +
      text.slice(start, end) +
      '</mark>' +
      text.slice(end);
  };
  cards.forEach(card => {
    const t = card.querySelector('.r-title');
    const s = card.querySelector('.r-snippet');
    if (t) highlight(t);
    if (s) highlight(s);
  });

  const sortCards = () => {
    if (sortMode === 'relevance') return cards;
    const dated = cards.filter(c => c.dataset.date);
    dated.sort((a, b) => {
      const da = new Date(a.dataset.date);
      const db = new Date(b.dataset.date);
      return sortMode === 'newest' ? db - da : da - db;
    });
    const undated = cards.filter(c => !c.dataset.date);
    return [...dated, ...undated];
  };

  const update = () => {
    const ordered = sortCards();
    const list = document.getElementById('result-list');
    ordered.forEach(c => list.appendChild(c));
    let visible = 0;
    ordered.forEach((c, idx) => {
      const match = !activeTypes.size || activeTypes.has(c.dataset.type);
      const show = idx < shown && match;
      c.classList.toggle('hidden', !show);
      if (show) visible++;
    });
    countEl.textContent = visible;
    if (visible < shown || shown >= ordered.length) btnMore.classList.add('hidden');
    else btnMore.classList.remove('hidden');
  };

  document.querySelectorAll('.filter-chip').forEach(btn => {
    btn.addEventListener('click', () => {
      const t = btn.dataset.type;
      if (activeTypes.has(t)) {
        activeTypes.delete(t);
        btn.classList.remove('bg-brand-500', 'text-white');
      } else {
        activeTypes.add(t);
        btn.classList.add('bg-brand-500', 'text-white');
      }
      shown = pageSize;
      update();
    });
  });

  document.getElementById('sort-select').addEventListener('change', e => {
    sortMode = e.target.value;
    shown = pageSize;
    update();
  });

  btnMore.addEventListener('click', () => {
    shown += pageSize;
    update();
  });

  update();
});
</script>
{% endif %}
{% endblock %}
